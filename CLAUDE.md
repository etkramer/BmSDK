# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

BmSDK is a C#-based scripting system for Batman: Arkham City that allows mods to add custom gameplay and logic to the game. The project consists of multiple components working together to provide a complete modding framework.

## Build System and Dependencies

The project uses MSBuild with Visual Studio 2022 and requires the x86 platform target. **Important**: BmSDK.Generator must be run at least once before BmSDK can be built, as it generates required bindings.

### Build Commands

- **Build all components**: `src\MSBuild.cmd BmSDK.slnx /t:BmSDK /t:BmSDK_Host /t:BmSDK_Generator`
- **Build generator only**: `src\MSBuild.cmd BmSDK.slnx /t:BmSDK_Generator`
- **VS Code tasks available**: "Build All" and "Build Generator"

### Build Dependencies

1. First run: Build BmSDK.Generator, then launch game to generate bindings
2. Subsequent builds: Can build all components together

### Output Locations

- SDK library: `bin\Binaries\Win32\sdk\BmSDK.dll`
- Generator plugin: `bin\Binaries\Win32\plugins\BmSDK.Generator.asi`
- Host plugin: `bin\Binaries\Win32\plugins\BmSDK.Host.asi`

## Architecture

### Core Components

1. **BmSDK (C# Library)** - Main scripting framework
   - Location: `src\BmSDK\`
   - Target: .NET 8.0 Windows (x86)
   - Core classes in `Classes\Core\` (GameObject, Class, Function, etc.)
   - Framework utilities in `Framework\` (Game, Script, Debug, etc.)
   - Internal systems in `FrameworkInternal\`

2. **BmSDK.Generator (C++ Plugin)** - Code generation and engine integration
   - Location: `src\BmSDK.Generator\`
   - Builds as `.asi` plugin that gets **injected into BatmanAC.exe process**
   - Uses vcpkg for dependencies
   - Handles UE3 engine integration and generates C# bindings

3. **BmSDK.Host (C++ Plugin)** - Runtime host for scripts
   - Location: `src\BmSDK.Host\`
   - Builds as `.asi` plugin that gets **injected into BatmanAC.exe process**
   - Provides the runtime environment for C# scripts

### Plugin Injection System

Both BmSDK.Generator and BmSDK.Host are `.asi` plugins that get injected into the target process (BatmanAC.exe) rather than being run as standalone programs or referenced by other projects. This allows them to hook into and extend the game's runtime.

### Generated Code

- Location: `src\BmSDK\Generated\`
- Contains auto-generated C# bindings for UE3 classes
- Organized by UE3 modules (Engine, BmGame, etc.)
- Files ending in `.g.cs` are auto-generated by BmSDK.Generator

### Script Development

- Scripts are placed in: `bin\BmGame\Scripts\`
- Development project: `bin\BmGame\ScriptsDev\ScriptsDev.csproj`
- Scripts inherit from `Script` base class with lifecycle methods:
  - `Main()` - Entry point when engine becomes ready
  - `OnEnterMenu()` - Called when entering main menu
  - `OnEnterGame()` - Called when loading into a game world
  - `OnTick()` - Called every world tick
  - `OnKeyDown(Keys key)` - Called on key press

### Key Classes and Systems

- **Game**: Static utility class for accessing game objects (GetPlayerController, GetWorldInfo, SpawnActor, etc.)
- **GameObject**: Base class for all UE3 objects with pointer management and validation
- **Script**: Base class for user scripts with event handlers
- **Class/Function/Property**: Reflection system for UE3 classes
- **RedirectManager**: System for hooking UnrealScript functions

## Development Workflow

1. **Initial setup**: Build and run BmSDK.Generator first to generate required bindings
2. Build the full solution using `src\MSBuild.cmd BmSDK.slnx /t:BmSDK /t:BmSDK_Host /t:BmSDK_Generator`
3. Copy output files to game directory (`bin\` contents go to game folder)
4. Create scripts in `bin\BmGame\Scripts\` directory
5. Use the ScriptsDev project for IntelliSense and development
6. Launch game with `-nosplash` for debugging

## Important Notes

- Only EGS (Epic Games Store) version of Batman: Arkham City is currently supported
- The project uses unsafe code extensively for native interop
- Scripts can access the full UE3 object hierarchy through generated bindings
- Function redirection allows overriding UnrealScript behavior with C# code
- Object lifetime management is critical - use `IsValid()` to check object validity
- BmSDK.Generator and BmSDK.Host run inside the game process, not as separate applications